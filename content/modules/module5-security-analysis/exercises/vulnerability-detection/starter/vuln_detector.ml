(** Vulnerability detector: combines taint propagation with
    security configuration to detect OWASP patterns.

    Uses Vuln_config for source/sink/sanitizer definitions.
    Detects vulnerabilities at Call nodes that are sinks
    when tainted arguments reach them.
*)

module Env = Abstract_domains.Abstract_env.MakeEnv (struct
  type t = Taint_domain.taint
  let bottom = Taint_domain.bottom
  let top = Taint_domain.top
  let join = Taint_domain.join
  let meet = Taint_domain.meet
  let leq = Taint_domain.leq
  let equal = Taint_domain.equal
  let widen = Taint_domain.widen
  let to_string = Taint_domain.to_string
end)

(** A detected vulnerability. *)
type vulnerability = {
  vuln_type : string;
  location : string;
  source_var : string;
  sink_name : string;
  message : string;
}

(** Severity levels for vulnerabilities. *)
type severity = Critical | High | Medium | Low

(** Determine severity from vulnerability type.
    - sql-injection, command-injection → Critical
    - xss, path-traversal → High
    - open-redirect → Medium
    - other → Low *)
let severity_of_vuln_type (_vt : string) : severity =
  failwith "TODO: map vulnerability type to severity"

(** Format severity as a string. *)
let string_of_severity (_s : severity) : string =
  failwith "TODO: format severity"

(** Evaluate an expression using the config to identify sources/sanitizers.
    - IntLit/BoolLit → Untainted
    - Var → lookup
    - BinOp → propagate
    - UnaryOp → propagate
    - Call to source → Tainted
    - Call to sanitizer → Untainted
    - Call to unknown → Top *)
let eval_expr (_config : Vuln_config.config) (_env : Env.t)
    (_e : Shared_ast.Ast_types.expr) : Taint_domain.taint =
  failwith "TODO: implement config-aware expression evaluation"

(** Check a Call node: if it's a sink and the checked argument
    is potentially tainted, return a vulnerability. *)
let check_call (_config : Vuln_config.config) (_env : Env.t)
    (_func_name : string) (_call_name : string)
    (_args : Shared_ast.Ast_types.expr list) : vulnerability list =
  failwith "TODO: check if call is a sink with tainted arguments"

(** Transfer a statement and check for vulnerabilities.
    Returns (updated_env, new_vulnerabilities). *)
let transfer_and_check (_config : Vuln_config.config) (_func_name : string)
    (_env : Env.t) (_s : Shared_ast.Ast_types.stmt)
    : Env.t * vulnerability list =
  failwith "TODO: transfer statement and check calls for vulnerabilities"

(** Analyze a single function: transfer body, collect vulnerabilities. *)
let analyze_function (_config : Vuln_config.config)
    (_func : Shared_ast.Ast_types.func_def) : vulnerability list =
  failwith "TODO: analyze function and return vulnerabilities"

(** Analyze a complete program (all functions). *)
let analyze_program (_config : Vuln_config.config)
    (_prog : Shared_ast.Ast_types.program) : vulnerability list =
  failwith "TODO: analyze all functions in program"

(** Format a vulnerability for display. *)
let format_vulnerability (_v : vulnerability) : string =
  failwith "TODO: format vulnerability as string"
