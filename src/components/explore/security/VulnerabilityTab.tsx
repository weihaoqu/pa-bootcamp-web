"use client";

import type { SecurityProgram } from "@/lib/security-explorer-data";
import { DEFAULT_SOURCES, DEFAULT_SINKS, DEFAULT_SANITIZERS } from "@/lib/security-explorer-data";

interface VulnerabilityTabProps {
  program: SecurityProgram;
}

export default function VulnerabilityTab({ program }: VulnerabilityTabProps) {
  const vulnSteps = program.steps.filter((s) => s.vulnerability);
  const sanitizedSteps = program.steps.filter((s) => s.sanitized);
  const hasVuln = vulnSteps.length > 0;

  return (
    <div className="p-3">
      <div className="mb-3">
        <h3 className="text-sm font-semibold text-navy">Vulnerability Report &amp; Security Config</h3>
        <p className="text-xs text-slate-500">
          Summary of findings for this program, plus the source/sink/sanitizer configuration used in the analysis.
        </p>
      </div>

      {/* Findings */}
      <div className={`mb-4 rounded-xl border p-4 ${hasVuln ? "border-red-200 bg-red-50" : "border-emerald-200 bg-emerald-50"}`}>
        <div className="mb-2 flex items-center gap-2">
          {hasVuln ? (
            <>
              <span className="flex h-6 w-6 items-center justify-center rounded-full bg-red-200 text-xs font-bold text-red-800">
                {vulnSteps.length}
              </span>
              <span className="text-sm font-semibold text-red-800">
                Vulnerability{vulnSteps.length > 1 ? "ies" : ""} Found
              </span>
            </>
          ) : (
            <>
              <span className="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-200 text-xs font-bold text-emerald-800">
                &#10003;
              </span>
              <span className="text-sm font-semibold text-emerald-800">No Vulnerabilities</span>
            </>
          )}
        </div>

        {vulnSteps.map((s, i) => (
          <div key={i} className="mb-2 rounded-lg border border-red-200 bg-white p-3">
            <div className="flex items-center gap-2">
              <span className={`rounded-full px-2 py-0.5 text-[10px] font-bold ${
                s.vulnerability!.severity === "Critical"
                  ? "bg-red-200 text-red-800"
                  : s.vulnerability!.severity === "High"
                    ? "bg-orange-200 text-orange-800"
                    : "bg-amber-200 text-amber-800"
              }`}>
                {s.vulnerability!.severity}
              </span>
              <span className="text-xs font-semibold text-red-800">{s.vulnerability!.type}</span>
              <span className="text-[10px] text-slate-400">Line {s.line}</span>
            </div>
            <p className="mt-1 text-xs text-red-700">{s.vulnerability!.message}</p>
          </div>
        ))}

        {sanitizedSteps.length > 0 && (
          <div className="mt-2 space-y-1">
            {sanitizedSteps.map((s, i) => (
              <div key={i} className="flex items-center gap-2 text-xs text-emerald-700">
                <span className="rounded-full bg-emerald-200 px-1.5 py-0.5 text-[10px] font-medium">SANITIZED</span>
                <span>Line {s.line}: {s.sanitized}</span>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Teaching point */}
      <div className="mb-4 rounded-lg border border-amber-200 bg-amber-50 p-3">
        <p className="text-[10px] font-medium text-amber-800">Key Insight</p>
        <p className="mt-1 text-xs text-amber-700">{program.teachingPoint}</p>
      </div>

      {/* Security Config reference */}
      <div className="space-y-3">
        <div>
          <h4 className="mb-1 text-xs font-semibold text-red-700">Sources (where taint enters)</h4>
          <div className="space-y-1">
            {DEFAULT_SOURCES.map((s) => (
              <div key={s.name} className="rounded border border-slate-200 bg-slate-50 p-2">
                <span className="text-xs font-medium text-navy">{s.name}</span>
                <span className="ml-2 text-[10px] text-slate-500">{s.description}</span>
                <div className="mt-0.5 flex flex-wrap gap-1">
                  {s.examples.map((ex) => (
                    <code key={ex} className="rounded bg-red-50 px-1 py-0.5 text-[9px] text-red-600">{ex}</code>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>

        <div>
          <h4 className="mb-1 text-xs font-semibold text-amber-700">Sinks (where taint is dangerous)</h4>
          <div className="space-y-1">
            {DEFAULT_SINKS.map((s) => (
              <div key={s.name} className="rounded border border-slate-200 bg-slate-50 p-2">
                <span className="text-xs font-medium text-navy">{s.name}</span>
                <span className="ml-2 rounded bg-amber-50 px-1 text-[10px] text-amber-700">{s.vulnType}</span>
                <div className="mt-0.5 flex flex-wrap gap-1">
                  {s.examples.map((ex) => (
                    <code key={ex} className="rounded bg-amber-50 px-1 py-0.5 text-[9px] text-amber-600">{ex}</code>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>

        <div>
          <h4 className="mb-1 text-xs font-semibold text-emerald-700">Sanitizers (break taint flow)</h4>
          <div className="space-y-1">
            {DEFAULT_SANITIZERS.map((s) => (
              <div key={s.name} className="rounded border border-slate-200 bg-slate-50 p-2">
                <span className="text-xs font-medium text-navy">{s.name}</span>
                <span className="ml-2 text-[10px] text-slate-500">{s.description}</span>
                <span className="ml-1 rounded bg-emerald-50 px-1 text-[10px] text-emerald-600">fixes: {s.sanitizes}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
